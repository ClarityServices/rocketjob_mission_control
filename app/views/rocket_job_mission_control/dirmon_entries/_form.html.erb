<% action ||= :create %>

<% if @dirmon_entry.errors.present? %>
  <div class='alert alert-alert'>Invalid Dirmon entry!</div>
  <% @dirmon_entry.errors.messages.each_pair do |field, message| %>
    <div class='message'><%= field %>: <%= message %></div>
  <% end %>
<% end %>

<%= form_for @dirmon_entry, url: {action: action} do |f| %>
  <div class='row'>
    <div class='col-md-6'>
      <div class='name form-group'>
        <%= f.label :name %>
        <%= f.text_field :name, class: 'form-control' %>
      </div>
    </div>

    <div class='col-md-6'>
      <div class='job form-group'>
        <%= f.label :job_class_name %>
        <%= f.text_field :job_class_name, class: 'form-control', disabled: action != :create %>
      </div>
    </div>
  </div>

  <div class='path form-group'>
    <%= f.label :pattern %>
    <%= f.text_field :pattern, class: 'form-control' %>
  </div>

  <div class='path form-group'>
    <%= f.label :archive_directory %>
    <%= f.text_field :archive_directory, class: 'form-control' %>
  </div>

  <div class='row'>
    <div class='col-md-12'>
      <% if @dirmon_entry.job_class %>
        <div class='lead'>Job Properties</div>

        <div class='arguments'>
          <div class='job_arguments form-group'></div>

          <%= f.fields_for :properties do |properties| %>
            <% @dirmon_entry.job_class.user_editable_fields.each do |property_name| %>
              <div class='form-group'>
                <%= properties.label property_name.to_s %>
                <%= editable_field_html(@dirmon_entry.job_class, property_name, @dirmon_entry.properties[property_name], properties, true) %>
              </div>
            <% end %>
            <% if @dirmon_entry.job_class.respond_to?(:defined_input_categories) && @dirmon_entry.job_class.respond_to?(:defined_output_categories) %>
              <div class='lead'>Input Categories</div>
              <% @job = @dirmon_entry.job_class.from_properties(@dirmon_entry.properties) %>
              <% @job.input_categories.each do |category| %>
                <div class='lead'><%= category.name.to_s.titleize %></div>
                <div class='form-group'>
                  <%= properties.label "Format" %>
                  <% options = extract_inclusion_values(RocketJob::Category::Input, :format) %>
                  <%= properties.select(:format, options, {include_blank: true, selected: category.format}, {class: "selectize form-control"}) %>
                  <%= properties.label "Columns" %>
                  <% options = Array(category.columns) %>
                  <%= properties.select(:columns, options_for_select(options, options), {include_hidden: false}, {class: "selectize form-control", multiple: true}) %>
                </div>
              <% end %>
              <div class='lead'>Output Categories</div>
              <% @job.output_categories.each do |category| %>
                <div class='lead'><%= category.name.to_s.titleize %></div>
                <div class='form-group'>
                  <%= properties.label "Format" %>
                  <% options = extract_inclusion_values(RocketJob::Category::Output, :format) %>
                  <%= properties.select(:format, options, {include_blank: true, selected: category.format}, {class: "selectize form-control"}) %>
                  <%= properties.label "Columns" %>
                  <% options = Array(category.columns) %>
                  <%= properties.select(:columns, options_for_select(options, options), {include_hidden: false}, {class: "selectize form-control", multiple: true}) %>
                </div>
              <% end %>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <div class='buttons pull-right'>
        <%= f.submit action, class: 'btn btn-primary' %>
        <%= link_to 'cancel', :back, class: 'btn btn-default' %>
      </div>

      <% if action == :create %>
        <%= button_tag 'properties',
                       type:  'button',
                       class: 'btn btn-default',
                       id:    'properties',
                       data:  {url: rocket_job_mission_control.new_dirmon_entry_path} %>
      <% end %>
    </div>
  </div>
<% end %>
